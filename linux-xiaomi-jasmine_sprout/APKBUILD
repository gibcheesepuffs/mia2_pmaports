# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/wayne_defconfig
# Maintainer: Roberto Acevedo <robante12@gmail.com>

pkgname=linux-xiaomi-jasmine_sprout
pkgver=4.4.226
pkgrel=0
pkgdesc="Xiaomi Mi A2 kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="xiaomi-jasmine_sprout"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="perl sed installkernel bash gmp-dev bc linux-headers elfutils-dev devicepkg-dev gcc6 gcc6-aarch64 openssl-dev"

# Compile with gcc6, kernel does not boot when built with newer versions
if [ "${CC:0:5}" != "gcc6-" ]; then
	CC="gcc6-$CC"
	HOSTCC="gcc6-gcc"
	CROSS_COMPILE="gcc6-$CROSS_COMPILE"
fi

# Source
_user="xiaomi-sdm660"
_repository="android_kernel_xiaomi_sdm660"
_commit="dd155506c8c44f5709986418c2eae66ae5720588"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/$_user/$_repository/archive/$_commit.tar.gz
	$_config
	0001-Use-relative-includes.patch
	0002-Fix-TRACE_INCLUDE_PATH-paths.patch
	0003-Add-config-option-to-fix-bootloader-cmdline-args.patch
"

builddir="$srcdir/$_repository-$_commit"


prepare() {
	default_prepare
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" $_carch $_flavor
	# External modules install
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS" \
		INSTALL_MOD_PATH="$pkgdir" modules_install
}

sha512sums="fb25962f4c82e3b5320d16013a1daeac26fe5fc43df4455517f4f22b0f4494ce079b486b2eb3381cb384471fa4a9def6d6bcb6009bb2d18976bd514672ff2876  linux-xiaomi-jasmine_sprout-dd155506c8c44f5709986418c2eae66ae5720588.tar.gz
fb522836a215f49c2ca75c627b170f2925993cd1a87a5820214742033bf8cbafe83a55ab933e89f5887cdb430c85e3309255f8ef055164cf40f885920e2f42eb  config-xiaomi-jasmine_sprout.aarch64
9f1b27e523675ecaafd0ffd884e3e8d0fe9b0bf78b09b5fe044a5d5c9888a86fb0007aa9d90118f0b022a4ace62c5be236097df3bb67a3207a24a766d0907c33  0001-Use-relative-includes.patch
a8713d22404a5e2c0d2add3deb4cb033e972bd1983e10f1557d4de640c1329af50be2bfd92dc3cf76df711a6b4a422b920da76c2d6c4435e3624c85f7d07ae52  0002-Fix-TRACE_INCLUDE_PATH-paths.patch
9ce867c4254b537ef5d2485780c26b72da8a3a8767ba71557f3b48d6c550e0e14c8c3e575b31bf65d2878f08a8a4926e48a1c2f1be534bf80a7a57f58313b0fd  0003-Add-config-option-to-fix-bootloader-cmdline-args.patch"
